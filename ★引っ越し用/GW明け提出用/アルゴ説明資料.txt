◯背景

◯新規性や工夫点
かんばんドメイン特化特徴量
・ある時点の在庫数から、同時間帯における在庫数の中央値を差し引いた差分を目的変数とすることで、周期的な正常在庫変動を除去し、通常水準からの逸脱を定量化した。
・滞留かんばんや前倒しかんばんの滞留時間、前倒し時間を考慮し、異常の大きさを「かんばん数×時間的逸脱量」というエネルギー的指標で定量化するアプローチを導入した。
・稼働日や休日、残業による稼働パターンの変動を考慮し、静的なリードタイム設定に伴う誤差を回避するため、動的リードタイム補正を組み込んだ特徴量設計手法を導入した。

◯モデル
・単調制約付きlightgbm
◯目的変数
・ある時点の在庫数ーその時点に対応する時間帯の在庫数中央値
◯説明変数
・期待在庫かんばん
・順立装置滞留かんばんー前倒しかんばん時間
・納入
・異常入庫
・滞留かんばん
・投入間口


説明変数
値


予定在庫かんばん数
入庫予定時間≦t≦出庫予定時間


物流センタ~部品置き場の滞留かんばん数
（入庫遅れかんばん数）
入庫予定≦t＜実績入庫時間


出庫前倒し-出庫遅れ差分かんばん数













◯目的変数
⚫️概要
ある時点の在庫数から、その時点に対応する時間帯における在庫数の中央値を差し引いた値を目的変数として設計した。
この設計により、在庫数に内在する周期的な時間変動を事前に除去し、通常の在庫水準からの乖離を明瞭に捉えることが可能となる。さらに、同変数は数値的連続量として異常度を定量的に表現可能であり、異常の大小や影響度に応じた分析判断が可能である。
⚫️説明
工場内の部品在庫（購買在庫）は、納入タイミングにより周期的なパターンを持つことが多い。従来はこの周期性を明示的に除去することなく、単純な在庫数量や在庫量時系列予測に基づく異常検知が行われてきた。しかしこのアプローチでは、通常運用内の自然な在庫変動と、本質的な異常を区別することが難しいという問題がある。そこで、本手法では、この課題に対処するために、「ある時点の在庫数から、その時点における在庫数の中央値を差し引いた差分量」を新たに目的変数として設計した。この差分量は、対象時点における通常在庫水準（周期的パターン）を基準とし、そこからの逸脱量だけをクリーンに抽出するものである。
この設計により、正常変動成分（納入タイミング）を事前に除去でき、異常シグナルをクリアかつロバストに抽出でき、さらに異常度を連続値で扱うことで重みづけ的な異常検出・優先度判断も可能となる。また、中央値を基準とするため、突発的な大納入・イベントによる外れ値にも頑健（ロバスト）であり、安定した学習・解釈が可能となる。

◯説明変数（かんばん要因）
⚫️概要
この特徴量は、ある時点 t において、t - かんばん回転日数以前に発注されたかんばんのうち、順立装置における入庫予定時間 ≦ t ＜ 出庫予定時間を満たすかんばんの数をカウントしたものである。これは、ある時点 t において期待される順立装置内の在庫水準を表現する指標であり、在庫量の土台（ベースライン）を規定するかんばん要因と考えられる。したがって、この特徴量の値が大きい場合は、在庫水準が増加し、小さい場合は在庫水準が減少すると考えられる。なお、本特徴量は、1日単位あるいはそれ以上の比較的長期的なスパンにおける在庫水準の変動を規定する要因として位置付けられる。
⚫️前処理
順立装置においては、先入先出し（FIFO）の原則が厳密には適用されていない。このため、在庫変動を適切に分析するには、入庫（IN）および出庫（OUT）の順序を仮想的にFIFOに準拠する形で補正することが必要である。
補正手順としては、まず入庫時刻（IN）を昇順に整列し、次に出庫時刻（OUT）も昇順に整列する。
その後、昇順に整列した入庫データに対し、同様に昇順に並べた出庫時刻を順次割り当てることで、仮想的なFIFO対応を構築する。
このようにして構築された仮想FIFOデータを用い、本分析では品番単位で在庫動態を把握する。
かんばんは、個々の箱に割り当てられているが、同一品番に属するかんばん同士は、機能品質の観点から同一であり、出庫順序による意味的な差異は存在しないとみなせる。したがって、個別かんばんの出庫順序は分析対象外とし、品番単位における在庫滞留量およびその推移に着目する。このような考え方は、本分析において関心の対象が、各品番が順立装置内にどの程度滞留しているか、すなわち品番ごとの滞留状況や推移にあるため、適切である。なお、入庫から出庫までの予定リードタイム（入庫出庫予定LT）については、実績データに基づく中央値を採用する。ただし、土日等の非稼働日を挟む場合には、リードタイムが延長するため、非稼働時間を考慮した補正を加える必要がある。具体的には、あらかじめ稼働日時および非稼働日時を定義し、出庫予定時間を算出する際には非稼働日時をスキップして計算する方法を採用する。
以下に、入庫予定時間および出庫予定時間の計算式を示す。
入庫予定時間=納入予定時間+納入入庫予定LT
出庫予定時間=入庫予定時間+入庫出庫予定LT

◯説明変数（生産要因）
⚫️概要
この特徴量は、ある時点 t における、過去数十時間にわたる特定の時間帯（t - τ, t）に対して、1分あたりの平均生産台数を計算したものである。この値は、生産活動における単位時間あたりの生産密度を表現しており、ある時点 t における順立装置内の在庫数に対する短期的な減衰要因として機能する。したがって、この特徴量の値が大きい場合は、在庫数が減少し、小さい場合は在庫数が増加すると考えられる。
⚫️前処理
一般的に、単位時間あたりの生産活動（生産密度）が高い場合、製品は順次後工程へと送り出され、順立装置内に滞留する在庫は速やかに減少する。また、逆に、生産密度が低下した場合は、製品の流れが滞るため、順立装置内に在庫が滞留し、在庫数が増加する傾向にある。ただし、生産密度は設計上のCTにより規定され、急激に増加することはない一方で、ライン停止や部品供給の問題等により一時的に低下することがある。このため、生産密度の低下は、順立装置内の在庫滞留を引き起こす主要な短期要因の一つとみなされる。
生産密度の影響を適切に捉えるためには、特定の時間帯における生産密度の平均値を用いることが有効である。これは、生産活動には瞬間的なばらつきが存在するため、単一時点の生産数では実態を正しく把握できず、ある程度まとまった時間範囲で平均化することによって、在庫水準に対する本質的な影響を抽出できるためである。また、極めて短い時間スケールにおける生産変動は、在庫全体への影響が限定的であり、ノイズ的な変動を除去する意味でも、特定期間の平均生産密度を評価指標とすることが適切である。このように、特定の時間帯における平均生産密度を用いることで、時点 t における順立装置内在庫数への即時的かつ実質的な影響を適切に評価することが可能となる。
>>
⚫️概要（間接バージョン）
本特徴量は、ある時点 t において、出庫予定を過ぎても滞留しているかんばんと、出庫予定より早く出庫されたかんばんについて、それぞれ滞留時間および前倒し時間をかんばん単位で積和し、滞留時間総和から前倒し時間総和を差し引いた差分として計算したものである。したがって、本特徴量が正の値を示す場合は、順立装置内で出庫予定を過ぎたかんばんの滞留が拡大していることを意味し、負の値の場合は、かんばんが前倒しで出庫され、在庫が予定よりも早く減少している状態を示す。これらの動きは生産進捗の遅延や前倒しと関連し、生産変動が順立装置内の在庫に与える影響を間接的に捉える指標となる。
⚫️説明（間接バージョン）
この特徴量は、ある時点 t において、順立装置内に存在するかんばん、または出庫実績が発生したかんばんに対して、出庫予定時間と実際の出庫状況との関係に基づき計算される。
まず、順立装置内に残存しており、出庫予定時間を過ぎてもなお出庫されていないかんばん（出庫予定時間 < t < 出庫実績時間、出庫遅延かんばん数
）について、現在時間と出庫予定時間の差分（滞留時間）を求め、これをかんばん単位で合計し、滞留かんばん総和時間と定義する。
次に、すでに出庫されたかんばんのうち、出庫予定時刻よりも早く出庫されたかんばん（出庫実績時間 < t < 出庫予定時間、出庫前倒しかんばん数）について、出庫予定時間と出庫実績時間の差分（前倒し時間）を求め、これをかんばん単位で合計し、前倒しかんばん総和時間と定義する。
本特徴量は、これら滞留かんばん総和時間から前倒しかんばん総和時間を差し引いた値として算出される。この特徴量が正の値をとる場合は、出庫予定時刻を過ぎてもなお出庫されていないかんばんが多く、かつ滞留している時間が長いことを意味し、順立装置内における在庫滞留の程度が高まっている状態を示す。一方、負の値をとる場合は、出庫予定よりも早く出庫されたかんばんが多く、かつ前倒し時間が大きいことを意味し、順立装置内の在庫が予定よりも早期に流動・消化されている状態を示す。
なお、かんばんの滞留や前倒しは、生産ラインにおける進捗状況の変動に起因する場合が多く、
生産が遅延した場合には順立装置内の滞留が増加し、生産が予定よりも早く進行した場合には在庫流動が促進される傾向がある。したがって、本特徴量は、生産進捗の遅延や前倒しによる影響が順立装置内在庫にどのように現れているかを間接的に定量把握するための指標として位置付けられる。
⚫️前処理（間接バージョン）
割愛
>>メモ
残業増えた場合、生産密度だと反映できない
合計の方がいい？
値としては、かんばん遅れ前倒し時間を使って、表で見せる値は生物にする？

◯説明変数（納入要因）
⚫️概要
この特徴量は、ある時点 t における在庫数に影響を及ぼす納入要因として、t - τ 時点に予定されていた納入かんばん数を示すものである。ここで τ（タウ）は、納入から入庫までのリードタイム（納入入庫LT）に相当し、時点 t において在庫数に寄与する納入かんばんの存在量を表現している。つまり、この特徴量は、一時的に在庫数を押し上げる上昇要因を定量化するものである。なお、実際の τ は稼働状況に応じて変動するため、稼働実績を基に動的に算出している。
⚫️前処理
　
◯説明変数（異常入庫）
この値は、ある時点 t の在庫数に影響を与える入庫要因として、通常の入庫予定（＝過去の納入予定かんばん数に納入入庫LTを加味して予測される値）では説明できない、異常な入庫かんばん数を示してたものである。具体的には、ある時点tで発生した入庫のうち、事前に予測されていなかった異常な増加分を抽出したもので、部品置き場からの入庫や前倒し入庫といった突発的な在庫増加の要因を捉える指標として位置付けられる。

◯説明変数（部品置き場で滞留）　
この特徴量は、ある時点tにおいて、順立装置入庫予定時間 ≦ t ＜ 出庫予定時間 を満たす各かんばん
について、滞留時間を算出し、これらを積算したものである。ここで滞留時間は、各かんばんに対して入庫予定時刻から現在時刻 t までの経過時間を指す。これは、ある時点 t における西尾東物流Cから部品置き場で滞留している状況を定量的に捉えるものであり、在庫数に対して短期的に減衰方向に影響を及ぼす要因として機能すると考えられる。したがって、この値が大きい場合は在庫も減少しし、少ない場合は在庫も増加すると考えられる

〇説明変数（順立装置）
この値は、ある時点 t の在庫数に影響を与える順立装置要因として、投入間口の渋滞時間を示したものめたる。順立装置では、箱種ごとに棚が割り当てられており、棚が満杯になると新たな入庫ができず、入り口の投入間口で箱が滞留する。この場合、入庫処理が行えないため、結果として在庫の減少に繋がる。なお、この値の計算については、全ての投入間口について最大容量に到達していないかをチェックし、いずれかの間口が上限に達していた場合に渋滞状態と判定し、その状態が継続していた経過時間で計算している。
